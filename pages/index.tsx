import Head from 'next/head'
// import Image from 'next/image'
import {
  useCallback,
  useMemo,
  useRef,
  useState,
  createRef,
  useEffect,
} from 'react'
import { gsap } from 'gsap'
import type { MouseEvent } from 'react'

import { BgCanvas } from '../components/BgCanvas'

import { fetchGraphQL } from '~/lib/api'

export interface ItemImage {
  size: number
  url: string
  width: number
  height: number
}

export interface ItemData {
  title: string
  url: string
  description: string
  image: ItemImage
}

export interface Item {
  image: ItemImage
  el: HTMLLIElement | null
}

export default function Home(props: any): JSX.Element {
  // const titles = useRef(null)
  // const titleCovers = useRef(null)

  const items = useRef<Item[]>(
    props.items.map((item: ItemData): Item => ({ image: item.image, el: null }))
  )
  const [selectedIndex, setSelectedIndex] = useState<number | undefined>(
    undefined
  )

  const tls = useRef<Map<number, gsap.core.Timeline>>(new Map())

  const createTl = useCallback(
    (el: HTMLLIElement | null, index: number): void => {
      console.log('createTl')

      if (el == null) {
        return
      }

      const title = el.querySelector('.title-text')
      const titleCover = el.querySelector('.title-cover')
      const desc = el.querySelector('.desc-text')

      gsap.set(title, {
        visibility: 'hidden',
      })
      gsap.set(titleCover, {
        transformOrigin: '0% 50%',
        scaleX: 0,
      })

      const tl = gsap
        .timeline({
          defaults: {
            duration: 0.45,
            ease: 'expo.inOut',
          },
        })
        .fromTo(
          titleCover,
          {
            scaleX: 0,
          },
          {
            scaleX: 1,
          }
        )
        .set(titleCover, {
          transformOrigin: '0% 50%',
        })
        .set(title, {
          visibility: 'hidden',
        })
        .set(title, {
          visibility: 'visible',
        })
        .set(titleCover, {
          transformOrigin: '100% 50%',
        })
        .fromTo(
          titleCover,
          {
            scaleX: 1,
          },
          {
            scaleX: 0,
          }
        )

      tl.seek(0.1)
      tl.pause(0)
      tls.current.set(index, tl)
    },
    []
  )

  const onMouseEnter = useCallback(
    (event: MouseEvent, index?: number): void => {
      const activeIndex = items.current.findIndex(
        (item: Item): boolean => item.el === event.currentTarget
      )

      setSelectedIndex(activeIndex)

      // const tl = tls.current[index]

      // if (tl instanceof gsap.core.Timeline) {
      //   tl.resume()
      // }

      tls.current.forEach(
        (tl: gsap.core.Timeline | null, key: number): void => {
          // tl?.pause()
          // tl?.reverse()
          if (key === activeIndex) {
            tl?.play()
          } else {
            tl?.reverse()
          }
        }
      )
    },
    []
  )

  const onMouseLeave = useCallback(() => {
    setSelectedIndex(undefined)

    tls.current.forEach((tl: gsap.core.Timeline | null): void => {
      // tl?.pause()
      tl?.reverse()
    })
  }, [])

  // const itemEl = useRef(
  //   props.items.map((itemData: ItemData, index: number) => {
  //     const classNames = ['content-item', 'relative']

  //     if (index !== 0) {
  //       classNames.push('mt-24')
  //     }

  //     return (
  //       <li
  //         key={itemData.title}
  //         className={classNames.join(' ')}
  //         ref={(ref) => {
  //           items.current[index].el = ref
  //         }}
  //         onMouseEnter={onMouseEnter}
  //         onMouseLeave={onMouseLeave}
  //       >
  //         <dl className="absolute top-6 -left-6 max-w-full content whitespace-pre-line">
  //           <dt className="inline-block relative text-6xl overflow-hidden">
  //             <span className="title-text">{itemData.title}</span>
  //             <span className="title-cover absolute inset-0 w-full h-full bg-purple-600"></span>
  //           </dt>
  //           <dd className="desc-text overflow-hidden">
  //             {itemData.description}
  //           </dd>
  //           <dd>
  //             <a href={itemData.url} target="_blank" rel="noreferrer noopener">
  //               見る
  //             </a>
  //           </dd>
  //         </dl>
  //       </li>
  //     )
  //   })
  // )

  useEffect(() => {
    items.current.forEach((item: Item, index: number) => {
      createTl(item.el, index)
    })
  }, [])

  return (
    <article>
      <Head>
        <title>Portfolio Shader</title>
        <meta name="description" content="Generated by create next app" />
      </Head>
      <BgCanvas
        className="fixed inset-0 w-full h-full pointer-events-none"
        bgImages={props.bgImages}
        contentImages={items.current}
        selectedIndex={selectedIndex}
      />
      <section
        className="fixed bottom-1 left-0 "
        style={{
          textOrientation: 'upright',
          writingMode: 'vertical-rl',
          textAlign: 'right',
        }}
      >
        <div>
          <a
            href="https://noliaki.netlify.app/about"
            target="_blank"
            rel="noreferrer"
            className="bg-black text-white hover:bg-white hover:text-black"
          >
            山田 典明
          </a>
        </div>
        <div>
          <a
            href="https://noliaki.netlify.app/product"
            target="_blank"
            rel="noreferrer"
            className="bg-purple-600 hover:bg-purple-50"
          >
            他作品
          </a>
        </div>
      </section>
      <section className="container max-w-screen-md mx-auto py-10">
        <ul>
          {props.items.map((itemData: ItemData, index: number) => {
            const classNames = ['content-item', 'relative']

            if (index !== 0) {
              classNames.push('mt-24')
            }

            return (
              <li
                key={itemData.title}
                className={classNames.join(' ')}
                ref={(ref) => {
                  items.current[index].el = ref
                }}
                onMouseEnter={onMouseEnter}
                onMouseLeave={onMouseLeave}
              >
                <dl className="absolute top-6 -left-6 max-w-full content whitespace-pre-line">
                  <dt className="inline-block relative text-6xl overflow-hidden">
                    <span className="title-text bg-white">
                      {itemData.title}
                    </span>
                    <span className="title-cover block absolute inset-0 w-full h-full bg-purple-600"></span>
                  </dt>
                  <dd className="desc-text overflow-hidden">
                    {itemData.description}
                  </dd>
                  <dd>
                    <a
                      href={itemData.url}
                      target="_blank"
                      rel="noreferrer noopener"
                    >
                      見る
                    </a>
                  </dd>
                </dl>
              </li>
            )
          })}
        </ul>
      </section>
    </article>
  )
}

export async function getStaticProps(): Promise<any> {
  const bgImages = await fetchGraphQL(
    `{
      backgroundImageCollection {
        items {
          image {
            url
            width
            height
          }
        }
      }
    }`
  )

  const items = await fetchGraphQL(
    `{
      artCollection {
        items {
          title
          url
          description
          image {
            size
            url
            width
            height
          }
        }
      }
    }`
  )

  return {
    props: {
      bgImages: bgImages?.data?.backgroundImageCollection?.items ?? [],
      items: items?.data?.artCollection?.items ?? [],
    },
  }
}
